<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Exploración de los medicamentos de Colombia de acuerdo con los datos del INVIMA</title>
</head>
<style>
.axis .domain {
    display: none;
}
</style>

<body>
    <h1>Exploración de los medicamentos de Colombia de acuerdo con los datos del INVIMA</h1>
    <form id="dimensions">
        <!--input type='radio' id="join" name="mode" checked>Join</input-->
        <input type='radio' id="principio_activo_1" name="mode" checked>Principio Activo</input>
        <input type='radio' id="vigentes" name="mode" checked>Vigentes</input>
        <input type='radio' id="renovacion" name="mode">Renovación</input>
        <input type='radio' id="vencidos" name="mode">Vencidos</input>
        <input type='radio' id="vitalesNO" name="mode">Vitales que no hay</input>
    </form>
    <svg width="960" height="500"></svg>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    
    <script>

    const readJSON = (path) => {
        return d3.json(path);
    }

    function dynamicSort(property) {
        var sortOrder = 1;

        if(property[0] === "-") {
            sortOrder = -1;
            property = property.substr(1);
        }

        return function (a,b) {
            if(sortOrder == -1){
                return b[property].localeCompare(a[property]);
            }else{
                return a[property].localeCompare(b[property]);
            }        
        }
    }

    function sum( obj ) {
      var sum = 0;
      for( var el in obj ) {
        if( obj.hasOwnProperty( el ) ) {
          sum += parseFloat( obj[el] );
        }
      }
      return sum;
    }

    let json2csv = (json) =>
    {
        const items = json;
        const replacer = (key, value) => value === null ? '' : value; // specify how you want to handle null values here
        // console.log((items[0]));
        const header = Object.keys(items[0]);
        let csv = items.map(row => header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(','));
        csv.unshift(header.join(','));
        csv = csv.join('\r\n');
        return csv;
    }

    function fastpivot(a){"use strict";var t={};if("string"!=typeof a&&a.length>0){var l=Object.keys(a[0]),n={};l.forEach(function(a){n[a]={},n[a]._labels=[],n[a]._labelsdata=[],n[a]._data={}}),a.forEach(function(a,t){l.forEach(function(t){var l=a[t];n[t]._data[l]=(n[t]._data[l]||0)+1,n[t]._labels[l]=null})}),l.forEach(function(a){for(var t in n[a]._data)n[a]._labelsdata.push(n[a]._data[t]);n[a]._labels=Object.keys(n[a]._labels)}),t=n}return t}


    const setDataSet = (rawDS, theKey1, theValues1, theKey2, theValues2) => {
        rawDS.then((ds) => {
            //console.log(ds[1]);
            //console.log(Object.keys(ds[1]));
            //Dataset to work with
            let pdAvg = d3.nest()
                .key((ds) => {
                    return ds[theKey1];
                })
                .key((ds) => {
                    let thedate = new Date(ds[theKey2]);
                    return thedate.getFullYear();
                })
                .rollup((v) => {
                    return {
                        count: v.length,
                        //total: d3.sum(v, function(d) { return d[theValues1]; }),
                        //avg: d3.mean(v, function(d) { return d.amount; })
                    };
                })
                .entries(ds);

            //console.log(pdAvg[10]);

            for (var property1 in pdAvg) {
                //console.log(pdAvg[property1].values);
                pdAvg[property1].values = pdAvg[property1].values.sort(dynamicSort("key"));
            }

            let t = 0;
            for (var property1 in pdAvg) {
                for (var prop in pdAvg[property1].values) {
                    //console.log(pdAvg[property1].values[prop].value.count);
                    //console.log(pdAvg[property1].values[prop].key);
                    t = pdAvg[property1].values[prop].value.count + t;
                }
                pdAvg[property1].total = t;
            }

            //console.log(pdAvg[0]);

            pdAvg.sort((a, b) => {
                //console.log(a);
                //console.log(b.total - a.total);
                return b.total - a.total;
                //
            });


        //var output = Object.entries(pdAvg).map(([key, value]) => ({key,value}));
        //-console.log(output);

        theArray = [];

        sgf = JSON.stringify(pdAvg);
        var json = JSON.parse(sgf);

        let mypivot = fastpivot(json);

        console.log(mypivot);

        //console.log((sgf));

        /*for (var prop1 in pdAvg) {
            for (var prop2 in pdAvg[prop1].values) {
                //console.log(pdAvg[prop1].key);
                let entries = d3.nest()
                .key(function(d) { 
                    console.log(d);
                    //return d.year; 
                })
                .entries(pdAvg[prop1]);

                //console.log(entries);
                //console.log(pdAvg[prop1].values[prop2]);
                //console.log(json2csv(pdAvg[prop1].values[prop2]));
                //theKeysforZ.push(pdAvg[prop1].key);
            }
        }*/

        //console.log(pdAvg);

        //console.log(json2csv(pdAvg));

        x.domain(pdAvg.map(function(d) {
            //console.log(d.key);
            return d.key;
        }));

        y.domain([0, d3.max(pdAvg, function(d) {
            return d.total;
        })]).nice();
        

        theKeysforZ = [];

        for (var property1 in pdAvg) {
            //console.log(pdAvg[property1]);
            for (var prop in pdAvg[property1].values) {
                //console.log(pdAvg[property1].values[prop]);
                theKeysforZ.push(pdAvg[property1].key);
            }
        }

        z.domain(theKeysforZ);

        //console.log(pdAvg);

        var entries = d3.nest()
        .key(function(d) { 
            //console.log(d);
            return d.year; 
        })
        .key(function(d) { return d.variety; })
        .entries(pdAvg);

        //console.log(entries);

        //console.log(theKeysforZ);

        const map1 = pdAvg.map(d => {
            //console.log(d.values);
            //d.keys;
        });

        //console.log(map1);

        g.append("g")
            .selectAll("g")
            .data(d3.stack().keys(theKeysforZ)(pdAvg))
            .enter().append("g")
            .attr("fill", function(d) {
                //console.log(d.key);
                return z(d.key);
            })
            .selectAll("rect")
            .data(function(d) {
                //console.log(d);
                return d;
            })
            .enter().append("rect")
            .attr("x", function(d) {
                //console.log(d.data);
                return x(d.data.key.values);
            })
            .attr("y", function(d) {
                return y(d[1]);
            })
            .attr("height", function(d) {
                return y(d[0]) - y(d[1]);
            })
            .attr("width", x.bandwidth());

        // g.append("g")
        //     .attr("class", "axis")
        //     .attr("transform", "translate(0," + height + ")")
        //     .call(d3.axisBottom(x));

        // g.append("g")
        //     .attr("class", "axis")
        //     .call(d3.axisLeft(y).ticks(null, "s"))
        //     .append("text")
        //     .attr("x", 2)
        //     .attr("y", y(y.ticks().pop()) + 0.5)
        //     .attr("dy", "0.32em")
        //     .attr("fill", "#000")
        //     .attr("font-weight", "bold")
        //     .attr("text-anchor", "start")
        //     .text("Population");

        // let legend = g.append("g")
        //     .attr("font-family", "sans-serif")
        //     .attr("font-size", 10)
        //     .attr("text-anchor", "end")
        //     .selectAll("g")
        //     .data(theKeysforZ.slice().reverse())
        //     .enter().append("g")
        //     .attr("transform", function(d, i) {
        //         return "translate(0," + i * 20 + ")";
        //     });

        // legend.append("rect")
        //     .attr("x", width - 19)
        //     .attr("width", 19)
        //     .attr("height", 19)
        //     .attr("fill", z);

        // legend.append("text")
        //     .attr("x", width - 24)
        //     .attr("y", 9.5)
        //     .attr("dy", "0.32em")
        //     .text(function(d) {
        //         return d;
        //     });

            /*console.log(pdAvg.sort());*/

            // for (let i = 0; i < pdAvg.length; i++) {
            //     top10.push(pdAvgSorted[i]);
            // }

//            let ordered = pdAvg[10].values.sort(dynamicSort("key"));

//            console.log(ordered);
//            console.log(pdAvg); 

            //let ordered = {};
            // Object.keys(pdAvg).sort().forEach((key) => {
            //     //console.log(key);
            //     ordered[key] = pdAvg[key];
            // });

            /*const pdAvgSorted = pdAvg.sort((a, b) => {
                //console.log(a.key);
                //console.log(a.key);
                //d3.ascending(a.value.total, b.value.total)
            });*/
            //console.log(pdAvgSorted);

            /*let top10 = [];
            for (let i = pdAvgSorted.length - 10; i < pdAvgSorted.length; i++) {
                top10.push(pdAvgSorted[i]);
            }*/
            //console.log(top10);
            //render(top10);
            // console.log(pdAvgSorted);
        });
    }


    let svg = d3.select("svg"),
        margin = {
            top: 20,
            right: 20,
            bottom: 30,
            left: 40
        },
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    let x = d3.scaleBand()
        .rangeRound([0, width])
        .paddingInner(0.05)
        .align(0.1);

    let y = d3.scaleLinear()
        .rangeRound([height, 0]);

    let z = d3.scaleOrdinal()
        .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

    const rawDS = readJSON("../datasets/C_DIGO__NICO_DE_MEDICAMENTOS_EN_TR_MITE_DE_RENOVACI_N.json");

    setDataSet(rawDS, "viaadministracion", "cantidad", "fechavencimiento");

    // rawDS.then((d) => {
    //     for (var index in d) {
    //         //console.log(Object.keys(d[0]));
    //         //console.log(d[0]['viaadministracion']);
    //         if (index != 'columns') {
    //             attrLen = Object.keys(d[index]).length;
    //             for (i = 1, t = 0; i < attrLen; ++i) {
    //                 col = Object.keys(d[index])[i];
    //                 console.log(d[index][col]);
    //                 t += d[index][col] = +d[index][col];
    //                 //t += d[columns[i]] = +d[columns[i]];

    //                 //console.log(t);
    //                 //console.log(d[i][col]);
    //             }
    //             //console.log(t);
    //             d[index].total = t;
    //         }
    //     }
        // let keys = d.columns.slice(1);
        // //console.log(keys);
        // //console.log(d);

        // d.sort((a, b) => {
        //     //console.log(a);
        //     //console.log(b.total - a.total);
        //     return b.total - a.total;
        //     //
        // });
        // x.domain(d.map(function(d) {
        //     //console.log(d);
        //     return d.viaadministracion;
        // }));

        // y.domain([0, d3.max(d, function(d) {
        //     return d.total;
        // })]).nice();
        // z.domain(keys);

        // g.append("g")
        //     .selectAll("g")
        //     .data(d3.stack().keys(keys)(d))
        //     .enter().append("g")
        //     .attr("fill", function(d) {
        //         return z(d.key);
        //     })
        //     .selectAll("rect")
        //     .data(function(d) {
        //         return d;
        //     })
        //     .enter().append("rect")
        //     .attr("x", function(d) {
        //         return x(d.data.State);
        //     })
        //     .attr("y", function(d) {
        //         return y(d[1]);
        //     })
        //     .attr("height", function(d) {
        //         return y(d[0]) - y(d[1]);
        //     })
        //     .attr("width", x.bandwidth());

        // g.append("g")
        //     .attr("class", "axis")
        //     .attr("transform", "translate(0," + height + ")")
        //     .call(d3.axisBottom(x));

        // g.append("g")
        //     .attr("class", "axis")
        //     .call(d3.axisLeft(y).ticks(null, "s"))
        //     .append("text")
        //     .attr("x", 2)
        //     .attr("y", y(y.ticks().pop()) + 0.5)
        //     .attr("dy", "0.32em")
        //     .attr("fill", "#000")
        //     .attr("font-weight", "bold")
        //     .attr("text-anchor", "start")
        //     .text("Population");

        // let legend = g.append("g")
        //     .attr("font-family", "sans-serif")
        //     .attr("font-size", 10)
        //     .attr("text-anchor", "end")
        //     .selectAll("g")
        //     .data(keys.slice().reverse())
        //     .enter().append("g")
        //     .attr("transform", function(d, i) {
        //         return "translate(0," + i * 20 + ")";
        //     });

        // legend.append("rect")
        //     .attr("x", width - 19)
        //     .attr("width", 19)
        //     .attr("height", 19)
        //     .attr("fill", z);

        // legend.append("text")
        //     .attr("x", width - 24)
        //     .attr("y", 9.5)
        //     .attr("dy", "0.32em")
        //     .text(function(d) {
        //         return d;
        //     });
    // });
    </script>
    <h1><a id="VisualAnalytics_0"></a>Visual-Analytics</h1>
    <h2><a></a>0) Código del Proyecto</h2>
    <ul>
        <li>Puede ser encontrado en el siguiente enlace <a href="https://github.com/vladcuevas/vladcuevas.github.io">https://github.com/vladcuevas/vladcuevas.github.io</a></li>
    </ul>
    <h2><a id="1_Objetivo_del_proyecto_y_tecnologas_usadas_2"></a>1) Objetivo del proyecto y tecnologías usadas</h2>
    <p>Proyecto que busca permitir explorar los medicamentos de Colombia y permitirles a los pacientes saber si sus medicamentos van a ser entregados por las EPS</p>
    <p>Las tecnologías utilizadas fueron:</p>
    <ul>
        <li>HTML5</li>
        <li>D3 v5</li>
        <li>JavaScript ECMAScript 2017</li>
        <li>CSS</li>
    </ul>
    <h2><a id="2_Cmo_se_corre_prerrequisitos_etc_13"></a>2) ¿Cómo se corre (prerrequisitos etc)?</h2>
    <ul>
        <li>Lo único necesario es acceder al enlace <a href="https://vladcuevas.github.io">vladcuevas.github.io</a></li>
    </ul>
    <h2><a id="3_Autores_con_links_y_link_a_la_pgina_del_proyecto_17"></a>3) Autores con links, y link a la página del proyecto</h2>
    <ul>
        <li>Vladimir E. Cuevas S. @ <a href="https://github.com/vladcuevas">https://github.com/vladcuevas</a></li>
    </ul>
    <h2><a id="4_Un_screenshot_21"></a>4) Un screenshot</h2>
    <p><img src="https://vladcuevas.github.io/images/screenshot.PNG" alt="alt text" style="width:800px;border-style: solid;border-color: red;"></p>
    <h2><a id="5_La_licencia_MIT_23"></a>5) La licencia MIT</h2>
    <ul>
        <li>La licencia <a href="https://github.com/vladcuevas/vladcuevas.github.io/blob/master/LICENSE">MIT</a> está incluida dentro del repositorio</li>
    </ul>
</body>

</html>